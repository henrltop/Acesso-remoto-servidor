{% extends 'file_manager/base.html' %}
{% load file_manager_filters %}

{% block title %}Navegador de Arquivos - SSH File Manager{% endblock %}

{% block extra_head %}
<!-- Estilos específicos da página index -->
<style>
    /* Estilo do cabeçalho do navegador de arquivos */
    .file-browser-header {
        background: linear-gradient(120deg, #f6f9fc, #edf2f7);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    
    [data-bs-theme="dark"] .file-browser-header {
        background: linear-gradient(120deg, #2d3748, #1a202c);
    }
    
    /* Estilos dos cartões de arquivos */
    .file-card {
        height: 100%;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s;
        position: relative;
    }
    
    .file-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .file-card .card-body {
        padding: 1rem;
    }
    
    /* Layout grid para visualização em grade */
    .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
    }
    
    /* Estilo do ícone de arquivo/pasta */
    .file-icon-wrapper {
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .file-icon-large {
        font-size: 3rem;
        transition: transform 0.3s;
    }
    
    /* Estilo do nome do arquivo */
    .file-name {
        text-align: center;
        font-size: 0.9rem;
        margin-top: 10px;
        word-break: break-word;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    
    /* Botões de ação para arquivos/pastas */
    .file-actions {
        position: absolute;
        top: 0;
        right: 0;
        padding: 5px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 0 0 0 10px;
        display: none;
        z-index: 10;
    }
    
    [data-bs-theme="dark"] .file-actions {
        background-color: rgba(40, 40, 40, 0.9);
    }
    
    .file-card:hover .file-actions {
        display: block;
        animation: fadeIn 0.2s;
    }
    
    .file-card:hover .file-icon-large {
        transform: scale(1.1);
    }
    
    /* Cores específicas para diferentes tipos de cartões */
    .folder-card {
        background: linear-gradient(135deg, #fff8e1, #fff8e1);
        border: none;
    }
    
    [data-bs-theme="dark"] .folder-card {
        background: linear-gradient(135deg, #4a3f00, #332b00);
    }
    
    .file-text-card {
        background: linear-gradient(135deg, #e3f2fd, #e1f5fe);
        border: none;
    }
    
    [data-bs-theme="dark"] .file-text-card {
        background: linear-gradient(135deg, #0a2636, #0a445a);
    }
    
    .file-image-card {
        background: linear-gradient(135deg, #f3e5f5, #ede7f6);
        border: none;
    }
    
    [data-bs-theme="dark"] .file-image-card {
        background: linear-gradient(135deg, #2a143b, #321b47);
    }
    
    .file-exec-card {
        background: linear-gradient(135deg, #e8f5e9, #dcedc8);
        border: none;
    }
    
    [data-bs-theme="dark"] .file-exec-card {
        background: linear-gradient(135deg, #103810, #1b421b);
    }
    
    .file-other-card {
        background: linear-gradient(135deg, #eceff1, #cfd8dc);
        border: none;
    }
    
    [data-bs-theme="dark"] .file-other-card {
        background: linear-gradient(135deg, #263238, #37474f);
    }
    
    /* Seletor de visualização (grade/lista) */
    .view-switcher .btn-icon {
        width: 40px;
        height: 40px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Container de navegação (breadcrumb) */
    .breadcrumb-container {
        overflow-x: auto;
        white-space: nowrap;
        scrollbar-width: thin;
        padding-bottom: 5px;
    }
    
    .breadcrumb-container::-webkit-scrollbar {
        height: 5px;
    }
    
    .breadcrumb-container::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }
    
    [data-bs-theme="dark"] .breadcrumb-container::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    /* Mensagem de pasta vazia */
    .empty-folder-message {
        text-align: center;
        padding: 50px 0;
    }
    
    .empty-folder-icon {
        font-size: 5rem;
        opacity: 0.5;
        margin-bottom: 20px;
    }
    
    .empty-folder-text {
        font-size: 1.2rem;
        color: #6c757d;
    }
    
    /* Botões de ação */
    .btn-action {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
    }
    
    /* Badges para tipos de arquivo */
    .file-badge {
        position: absolute;
        bottom: 5px;
        right: 5px;
        font-size: 0.7em;
        padding: 3px 6px;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }
    
    [data-bs-theme="dark"] .file-badge {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .folder-badge {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ff9800;
    }
    
    [data-bs-theme="dark"] .folder-badge {
        color: #ffc107;
    }
    
    /* Estilo dos modals */
    .modal-content {
        border-radius: 15px;
        overflow: hidden;
    }
    
    .modal-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-bottom: none;
    }
    
    .btn-close {
        filter: brightness(0) invert(1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Cabeçalho do navegador de arquivos -->
<div class="file-browser-header animate__animated animate__fadeIn">
    <div class="row align-items-center">
        <!-- Breadcrumb para navegação -->
        <div class="col-md-8">
            <div class="breadcrumb-container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item">
                            <a href="{% url 'index' %}" class="d-flex align-items-center">
                                <i class="fas fa-home me-1"></i> Home
                            </a>
                        </li>
                        {% for part in path_parts %}
                            <li class="breadcrumb-item">
                                <a href="{% url 'index' %}?path={{ part.path }}">{{ part.name }}</a>
                            </li>
                        {% endfor %}
                    </ol>
                </nav>
            </div>
        </div>
        <!-- Botões de alternar visualização (grid/lista) -->
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="btn-group view-switcher" role="group">
                <button type="button" class="btn btn-outline-primary btn-icon active" id="gridViewBtn" title="Visualização em grid">
                    <i class="fas fa-th"></i>
                </button>
                <button type="button" class="btn btn-outline-primary btn-icon" id="listViewBtn" title="Visualização em lista">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Barra de ações (voltar, nova pasta, upload) e busca -->
<div class="row mb-4">
    <!-- Botões de ação -->
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="btn-group">
            {% if current_path != '.' %}
                <a href="{% url 'index' %}?path={{ parent_path }}" class="btn btn-outline-primary animate__animated animate__fadeInLeft">
                    <i class="fas fa-arrow-left me-1"></i> Voltar
                </a>
            {% endif %}
            <button class="btn btn-primary animate__animated animate__fadeInLeft" data-bs-toggle="modal" data-bs-target="#newDirModal">
                <i class="fas fa-folder-plus me-1"></i> Nova Pasta
            </button>
            <button class="btn btn-success animate__animated animate__fadeInLeft" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fas fa-upload me-1"></i> Upload
            </button>
        </div>
    </div>
    <!-- Campo de busca/filtro -->
    <div class="col-md-6">
        <div class="input-group animate__animated animate__fadeInRight">
            <span class="input-group-text bg-white border-end-0">
                <i class="fas fa-search text-muted"></i>
            </span>
            <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Filtrar arquivos...">
        </div>
    </div>
</div>

<!-- Mensagem de erro caso não consiga conectar via SSH -->
{% if error %}
    <div class="alert alert-danger animate__animated animate__fadeIn">
        <i class="fas fa-exclamation-triangle me-2"></i> {{ error }}
    </div>
{% else %}
    <!-- Container principal de arquivos/pastas -->
    <div class="card animate__animated animate__fadeIn">
        <!-- Cabeçalho da listagem com caminho atual -->
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <span><i class="fas fa-folder-open me-2"></i>{{ current_path }}</span>
            <span class="badge bg-primary rounded-pill" id="fileCounter">{{ files|length }} itens</span>
        </div>
        
        <div class="card-body">
            <!-- Grid View (visualização em grade) -->
            <div id="gridView" class="file-grid">
                {% for file in files %}
                    {% with extension=file.name|split:"." %}
                    <div class="file-item animate__animated animate__zoomIn">
                        <!-- Cartão do arquivo/pasta com estilo baseado no tipo -->
                        <div class="file-card {% if file.type == 'dir' %}folder-card{% elif extension|last in 'txt,md,py,js,html,css,php,json,xml,c,cpp,h,java' %}file-text-card{% elif extension|last in 'jpg,jpeg,png,gif,svg,webp,bmp' %}file-image-card{% elif extension|last in 'exe,sh,bash,bat,cmd' %}file-exec-card{% else %}file-other-card{% endif %}">
                            {% if file.type == 'dir' %}
                                <!-- Renderização para diretórios -->
                                <a href="{% url 'index' %}?path={{ current_path }}/{{ file.name }}" class="text-decoration-none">
                                    <div class="file-icon-wrapper">
                                        <i class="fas fa-folder text-warning file-icon-large"></i>
                                    </div>
                                    <div class="file-name">
                                        {{ file.name }}
                                    </div>
                                </a>
                                <span class="file-badge folder-badge">pasta</span>
                            {% else %}
                                <!-- Renderização para arquivos -->
                                <div class="file-icon-wrapper">
                                    {% if extension|last == 'py' %}
                                        <i class="fab fa-python text-primary file-icon-large"></i>
                                    {% elif extension|last in 'js,json' %}
                                        <i class="fab fa-js-square text-warning file-icon-large"></i>
                                    {% elif extension|last in 'html,htm' %}
                                        <i class="fab fa-html5 text-danger file-icon-large"></i>
                                    {% elif extension|last == 'css' %}
                                        <i class="fab fa-css3-alt text-info file-icon-large"></i>
                                    {% elif extension|last == 'php' %}
                                        <i class="fab fa-php text-primary file-icon-large"></i>
                                    {% elif extension|last in 'jpg,jpeg,png,gif,svg,webp,bmp' %}
                                        <i class="fas fa-image text-success file-icon-large"></i>
                                    {% elif extension|last == 'md' %}
                                        <i class="fab fa-markdown text-secondary file-icon-large"></i>
                                    {% elif extension|last == 'pdf' %}
                                        <i class="fas fa-file-pdf text-danger file-icon-large"></i>
                                    {% elif extension|last in 'doc,docx' %}
                                        <i class="fas fa-file-word text-primary file-icon-large"></i>
                                    {% elif extension|last in 'xls,xlsx' %}
                                        <i class="fas fa-file-excel text-success file-icon-large"></i>
                                    {% elif extension|last in 'ppt,pptx' %}
                                        <i class="fas fa-file-powerpoint text-warning file-icon-large"></i>
                                    {% elif extension|last in 'zip,rar,tar,gz,7z' %}
                                        <i class="fas fa-file-archive text-secondary file-icon-large"></i>
                                    {% elif extension|last in 'exe,msi' %}
                                        <i class="fas fa-cog text-secondary file-icon-large"></i>
                                    {% elif extension|last in 'sh,bash' %}
                                        <i class="fas fa-terminal text-success file-icon-large"></i>
                                    {% else %}
                                        <i class="fas fa-file text-secondary file-icon-large"></i>
                                    {% endif %}
                                </div>
                                <div class="file-name">
                                    {{ file.name }}
                                </div>
                                <span class="file-badge">{{ extension|last }}</span>
                            {% endif %}
                            
                            <!-- Botões de ação para o arquivo/pasta -->
                            <div class="file-actions">
                                <div class="btn-group">
                                    {% if file.type == 'dir' %}
                                        <!-- Ações para diretórios -->
                                        <button class="btn btn-sm btn-warning rename-btn" data-path="{{ current_path }}/{{ file.name }}" data-name="{{ file.name }}" title="Renomear">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-dir-btn" data-path="{{ current_path }}/{{ file.name }}" data-name="{{ file.name }}" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    {% else %}
                                        <!-- Ações para arquivos -->
                                        <a href="{% url 'edit_file' path=current_path|add:'/'|add:file.name %}" class="btn btn-sm btn-primary" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        
                                        <!-- Botão de Executar para arquivos de código -->
                                        {% if extension|last in 'py,js,php,sh,bash' %}
                                        <a href="{% url 'execute_code_view' path=current_path|add:'/'|add:file.name %}" class="btn btn-sm btn-success" title="Executar">
                                            <i class="fas fa-play"></i>
                                        </a>
                                        {% endif %}
                                        
                                        <a href="{% url 'download_file' %}?path={{ current_path }}/{{ file.name }}" class="btn btn-sm btn-success" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button class="btn btn-sm btn-warning rename-btn" data-path="{{ current_path }}/{{ file.name }}" data-name="{{ file.name }}" title="Renomear">
                                            <i class="fas fa-font"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-file-btn" data-path="{{ current_path }}/{{ file.name }}" data-name="{{ file.name }}" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% empty %}
                    <!-- Mensagem para pastas vazias -->
                    <div class="empty-folder-message animate__animated animate__fadeIn" style="grid-column: 1 / -1;">
                        <i class="fas fa-folder-open empty-folder-icon"></i>
                        <p class="empty-folder-text">Esta pasta está vazia</p>
                        <p class="text-muted">Crie uma pasta ou faça upload de arquivos</p>
                    </div>
                {% endfor %}
            </div>
            
            <!-- List View (visualização em lista) -->
            <div id="listView" class="d-none">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tamanho</th>
                                <th>Permissões</th>
                                <th style="width: 150px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="fileList">
                            {% for file in files %}
                                <tr class="file-item animate__animated animate__fadeInUp" style="animation-delay: {{ forloop.counter0|divisibleby:10 }}0ms">
                                    <td>
                                        {% if file.type == 'dir' %}
                                            <a href="{% url 'index' %}?path={{ current_path }}/{{ file.name }}" class="directory">
                                                <i class="fas fa-folder text-warning file-icon"></i> {{ file.name }}
                                            </a>
                                        {% else %}
                                            <i class="fas fa-file text-secondary file-icon"></i> {{ file.name }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if file.type == 'dir' %}
                                            <span class="badge bg-warning text-dark">PASTA</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ file.size|filesizeformat }}</span>
                                        {% endif %}
                                    </td>
                                    <td><code>{{ file.permissions }}</code></td>
                                    <td>
                                        <div class="btn-group">
                                            {% if file.type == 'dir' %}
                                                <!-- Ações para diretórios (visualização em lista) -->
                                                <button class="btn btn-sm btn-warning rename-btn btn-action" data-path="{{ current_path }}/{{ file.name }}" data-name="{{ file.name }}" title="Renomear">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger delete-dir-btn btn-action" data-path="{{ current_path }}/{{ file.name }}" data-name="{{ file.name }}" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% else %}
                                                <!-- Ações para arquivos (visualização em lista) -->
                                                <a href="{% url 'edit_file' path=current_path|add:'/'|add:file.name %}" class="btn btn-sm btn-primary btn-action" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                
                                                <!-- Botão de Executar para arquivos de código (visualização em lista) -->
                                                {% with extension=file.name|split:"." %}
                                                {% if extension|last in 'py,js,php,sh,bash' %}
                                                <a href="{% url 'execute_code_view' path=current_path|add:'/'|add:file.name %}" class="btn btn-sm btn-success btn-action" title="Executar">
                                                    <i class="fas fa-play"></i>
                                                </a>
                                                {% endif %}
                                                {% endwith %}
                                                
                                                <a href="{% url 'download_file' %}?path={{ current_path }}/{{ file.name }}" class="btn btn-sm btn-success btn-action" title="Download">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <button class="btn btn-sm btn-warning rename-btn btn-action" data-path="{{ current_path }}/{{ file.name }}" data-name="{{ file.name }}" title="Renomear">
                                                    <i class="fas fa-font"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger delete-file-btn btn-action" data-path="{{ current_path }}/{{ file.name }}" data-name="{{ file.name }}" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% empty %}
                                <!-- Mensagem para pastas vazias (visualização em lista) -->
                                <tr>
                                    <td colspan="4" class="text-center py-5">
                                        <i class="fas fa-folder-open text-muted mb-3" style="font-size: 3rem;"></i>
                                        <p class="text-muted mb-0">Esta pasta está vazia</p>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- MODALS: -->

<!-- Modal Nova Pasta -->
<div class="modal fade" id="newDirModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-folder-plus me-2"></i>Nova Pasta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="dirName" class="form-label">Nome da Pasta</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-folder text-warning"></i></span>
                        <input type="text" class="form-control" id="dirName" placeholder="Nome da nova pasta" autofocus>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="createDirBtn">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    <i class="fas fa-check me-1"></i>Criar Pasta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-upload me-2"></i>Upload de Arquivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileUpload" class="form-label">Selecione o arquivo</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-file-arrow-up"></i></span>
                            <input class="form-control" type="file" id="fileUpload" name="file">
                        </div>
                        <div class="form-text">Arraste e solte ou clique para selecionar um arquivo</div>
                    </div>
                </form>
                <div class="progress d-none mt-3" id="uploadProgress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="uploadBtn">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    <i class="fas fa-cloud-arrow-up me-1"></i>Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Renomear -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Renomear</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="renamePath">
                <div class="mb-3">
                    <label for="newName" class="form-label">Novo nome</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-font"></i></span>
                        <input type="text" class="form-control" id="newName" autofocus>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="renameBtn">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    <i class="fas fa-check me-1"></i>Renomear
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Delete -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content animate__animated animate__fadeInUp">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-trash-alt text-danger" style="font-size: 3rem;"></i>
                </div>
                <p class="text-center">Tem certeza que deseja excluir <br><strong id="deleteItemName" class="text-danger"></strong>?</p>
                <p class="text-center text-muted small">Esta ação não pode ser desfeita</p>
                <input type="hidden" id="deleteItemPath">
                <input type="hidden" id="deleteItemType">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    <i class="fas fa-trash me-1"></i>Excluir
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- JavaScript para manipulação do navegador de arquivos -->
<script>
    $(document).ready(function() {
        // Alternância de visualização (grid/lista)
        $("#gridViewBtn").click(function() {
            $("#gridView").removeClass("d-none");
            $("#listView").addClass("d-none");
            $("#gridViewBtn").addClass("active");
            $("#listViewBtn").removeClass("active");
            localStorage.setItem('fileViewMode', 'grid');
        });
        
        $("#listViewBtn").click(function() {
            $("#gridView").addClass("d-none");
            $("#listView").removeClass("d-none");
            $("#gridViewBtn").removeClass("active");
            $("#listViewBtn").addClass("active");
            localStorage.setItem('fileViewMode', 'list');
        });
        
        // Restaurar preferência de visualização
        const viewMode = localStorage.getItem('fileViewMode');
        if (viewMode === 'list') {
            $("#listViewBtn").click();
        }
        
        // Filtro de busca com animação
        $("#searchInput").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            
            // Atualiza contador de arquivos visíveis
            let visibleCount = 0;
            
            $("#gridView .file-item").each(function() {
                const shouldShow = $(this).text().toLowerCase().indexOf(value) > -1;
                if(shouldShow) visibleCount++;
                
                if(shouldShow && $(this).is(":hidden")) {
                    $(this).addClass("animate__animated animate__zoomIn");
                    $(this).show();
                } else if(!shouldShow && !$(this).is(":hidden")) {
                    $(this).addClass("animate__animated animate__zoomOut");
                    setTimeout(() => {
                        $(this).hide();
                        $(this).removeClass("animate__animated animate__zoomOut");
                    }, 300);
                }
            });
            
            $("#listView .file-item").filter(function() {
                return $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
            
            $("#fileCounter").text(visibleCount + " itens");
        });
        
        // Abrir modais com foco em inputs
        $('#newDirModal').on('shown.bs.modal', function() {
            $('#dirName').focus();
        });
        
        $('#renameModal').on('shown.bs.modal', function() {
            $('#newName').focus();
        });
        
        // Criar nova pasta com animação de carregamento
        $("#createDirBtn").click(function() {
            const dirName = $("#dirName").val().trim();
            
            if (!dirName) {
                alert("Digite um nome para a pasta");
                return;
            }
            
            const spinner = $(this).find('.spinner-border');
            spinner.show();
            
            $.ajax({
                url: "{% url 'api_file_operations' %}",
                type: "POST",
                data: {
                    operation: "create_directory",
                    path: "{{ current_path }}",
                    name: dirName
                },
                success: function(response) {
                    if (response.success) {
                        window.location.reload();
                    } else {
                        alert("Erro ao criar pasta: " + (response.error || "Erro desconhecido"));
                    }
                    spinner.hide();
                },
                error: function(xhr, status, error) {
                    alert("Erro ao criar pasta: " + error);
                    spinner.hide();
                }
            });
            
            $("#newDirModal").modal('hide');
        });
        
        // Upload de arquivo com barra de progresso simulada
        $("#uploadBtn").click(function() {
            const fileInput = document.getElementById('fileUpload');
            
            if (!fileInput.files[0]) {
                alert("Selecione um arquivo para upload");
                return;
            }
            
            const spinner = $(this).find('.spinner-border');
            spinner.show();
            
            // Mostrar barra de progresso
            const progressBar = $("#uploadProgress");
            progressBar.removeClass("d-none");
            const progressIndicator = progressBar.find(".progress-bar");
            
            // Simular progresso
            let progress = 0;
            const progressInterval = setInterval(function() {
                progress += 5;
                if (progress > 90) clearInterval(progressInterval);
                progressIndicator.css("width", progress + "%");
                progressIndicator.attr("aria-valuenow", progress);
            }, 200);
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('operation', 'upload');
            formData.append('path', "{{ current_path }}");
            
            $.ajax({
                url: "{% url 'api_file_operations' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    clearInterval(progressInterval);
                    if (response.success) {
                        progressIndicator.css("width", "100%");
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    } else {
                        alert("Erro no upload: " + (response.error || "Erro desconhecido"));
                    }
                    spinner.hide();
                },
                error: function(xhr, status, error) {
                    clearInterval(progressInterval);
                    progressIndicator.addClass("bg-danger");
                    alert("Erro no upload: " + error);
                    spinner.hide();
                }
            });
            
            $("#uploadModal").modal('hide');
        });
        
        // Abrir modal de renomear
        $(".rename-btn").click(function() {
            const path = $(this).data('path');
            const name = $(this).data('name');
            
            $("#renamePath").val(path);
            $("#newName").val(name);
            $("#renameModal").modal('show');
        });
        
        // Renomear arquivo/pasta
        $("#renameBtn").click(function() {
            const path = $("#renamePath").val();
            const newName = $("#newName").val().trim();
            
            if (!newName) {
                alert("Digite um nome válido");
                return;
            }
            
            const spinner = $(this).find('.spinner-border');
            spinner.show();
            
            $.ajax({
                url: "{% url 'api_file_operations' %}",
                type: "POST",
                data: {
                    operation: "rename",
                    path: path,
                    new_name: newName
                },
                success: function(response) {
                    if (response.success) {
                        window.location.reload();
                    } else {
                        alert("Erro ao renomear: " + (response.error || "Erro desconhecido"));
                    }
                    spinner.hide();
                },
                error: function(xhr, status, error) {
                    alert("Erro ao renomear: " + error);
                    spinner.hide();
                }
            });
            
            $("#renameModal").modal('hide');
        });
        
        // Abrir modal de confirmação de exclusão para arquivos
        $(".delete-file-btn").click(function() {
            const path = $(this).data('path');
            const name = $(this).data('name');
            
            $("#deleteItemPath").val(path);
            $("#deleteItemName").text(name);
            $("#deleteItemType").val('file');
            $("#deleteConfirmModal").modal('show');
        });
        
        // Abrir modal de confirmação de exclusão para diretórios
        $(".delete-dir-btn").click(function() {
            const path = $(this).data('path');
            const name = $(this).data('name');
            
            $("#deleteItemPath").val(path);
            $("#deleteItemName").text(name);
            $("#deleteItemType").val('directory');
            $("#deleteConfirmModal").modal('show');
        });
        
        // Confirmar exclusão
        $("#confirmDeleteBtn").click(function() {
            const path = $("#deleteItemPath").val();
            const type = $("#deleteItemType").val();
            
            const spinner = $(this).find('.spinner-border');
            spinner.show();
            
            $.ajax({
                url: "{% url 'api_file_operations' %}",
                type: "POST",
                data: {
                    operation: type === 'file' ? "delete_file" : "delete_directory",
                    path: path
                },
                success: function(response) {
                    if (response.success) {
                        window.location.reload();
                    } else {
                        alert("Erro ao excluir: " + (response.error || "Erro desconhecido"));
                    }
                    spinner.hide();
                },
                error: function(xhr, status, error) {
                    alert("Erro ao excluir: " + error);
                    spinner.hide();
                }
            });
            
            $("#deleteConfirmModal").modal('hide');
        });
        
        // Suporte para arrastar e soltar
        const dropArea = document.getElementById('fileUpload');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.parentElement.parentElement.classList.add('border', 'border-primary');
        }
        
        function unhighlight() {
            dropArea.parentElement.parentElement.classList.remove('border', 'border-primary');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            dropArea.files = files;
            
            // Mostra nome do arquivo
            if (files.length > 0) {
                $('#uploadBtn').prop('disabled', false);
            }
        }
    });
</script>
{% endblock %}